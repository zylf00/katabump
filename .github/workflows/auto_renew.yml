# .github/workflows/auto_renew.yml
name: Auto Server Renew

on:
  # 定时运行 - 每天UTC 2点（北京时间10点）
  schedule:
    - cron: '0 2 * * *'
  
  # 手动触发
  workflow_dispatch:
    inputs:
      reason:
        description: '手动运行原因'
        required: false
        default: '手动测试'
        type: string

# 环境变量
env:
  PYTHONUNBUFFERED: 1
  DISPLAY: :99

# 设置权限
permissions:
  contents: read

jobs:
  renew-server:
    name: 续期服务器
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: 📥 检出代码
        uses: actions/checkout@v4
        
      - name: 🐍 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: 📦 安装系统依赖
        run: |
          # 更新包列表
          sudo apt-get update -qq
          
          # 安装Chrome和相关依赖
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update -qq
          
          sudo apt-get install -y -qq \
            google-chrome-stable \
            xvfb \
            fonts-liberation \
            libasound2 \
            libatk-bridge2.0-0 \
            libdrm2 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libgbm1 \
            libxss1 \
            libnss3
            
      - name: 🔍 检查Chrome版本
        run: |
          CHROME_VERSION=$(google-chrome --version)
          echo "Chrome版本: $CHROME_VERSION"
          
      - name: 📦 安装Python依赖
        run: |
          python -m pip install --upgrade pip
          pip install \
            selenium==4.15.0 \
            undetected-chromedriver \
            playwright==1.40.0 \
            requests \
            loguru
            
      - name: 🎭 安装Playwright浏览器
        run: |
          playwright install chromium
          
      - name: 🖥️ 启动虚拟显示
        run: |
          # 启动Xvfb虚拟显示服务器
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "虚拟显示已启动"
          
      - name: 🚀 运行续期脚本
        env:
          EMAIL: ${{ secrets.
