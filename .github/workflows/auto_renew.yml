# .github/workflows/auto_renew.yml
name: Auto Server Renew

on:
  # å®šæ—¶è¿è¡Œ - æ¯å¤©UTC 2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰
  schedule:
    - cron: '0 2 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡ŒåŸå› '
        required: false
        default: 'æ‰‹åŠ¨æµ‹è¯•'
        type: string

# ç¯å¢ƒå˜é‡
env:
  PYTHONUNBUFFERED: 1
  DISPLAY: :99

# è®¾ç½®æƒé™
permissions:
  contents: read

jobs:
  renew-server:
    name: ç»­æœŸæœåŠ¡å™¨
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          # æ›´æ–°åŒ…åˆ—è¡¨
          sudo apt-get update -qq
          
          # æ–¹æ³•1: ä½¿ç”¨å®˜æ–¹æ¨èçš„æ–°æ–¹å¼å®‰è£…Chrome
          curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update -qq
          
          # å…ˆå°è¯•å®‰è£…Chrome
          sudo apt-get install -y -qq google-chrome-stable || {
            echo "Chromeå®‰è£…å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ..."
            # å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä¸‹è½½Chrome debåŒ…
            wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
            sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get install -f -y
          }
          
          # å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆå¤„ç†Ubuntuç‰ˆæœ¬å·®å¼‚ï¼‰
          sudo apt-get install -y -qq \
            xvfb \
            fonts-liberation \
            ca-certificates \
            fonts-noto-color-emoji \
            libxss1 \
            libgbm1 \
            libdrm2 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libnss3 \
            libatk-bridge2.0-0 \
            libgtk-3-0 \
            libatspi2.0-0 || {
            # å¦‚æœéƒ¨åˆ†åŒ…å®‰è£…å¤±è´¥ï¼Œå°è¯•æ›¿ä»£åŒ…å
            echo "å°è¯•å®‰è£…æ›¿ä»£åŒ…å..."
            sudo apt-get install -y -qq \
              libasound2-dev \
              libasound2t64 \
              || sudo apt-get install -y -qq libasound2 || echo "éŸ³é¢‘åº“å®‰è£…è·³è¿‡"
          }
            
      - name: ğŸ” æ£€æŸ¥Chromeç‰ˆæœ¬
        run: |
          CHROME_VERSION=$(google-chrome --version)
          echo "Chromeç‰ˆæœ¬: $CHROME_VERSION"
          
      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install \
            selenium==4.15.0 \
            undetected-chromedriver \
            playwright==1.40.0 \
            requests \
            loguru
            
      - name: ğŸ­ å®‰è£…Playwrightæµè§ˆå™¨
        run: |
          playwright install chromium
          
      - name: ğŸ–¥ï¸ å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤º
        run: |
          # å¯åŠ¨Xvfbè™šæ‹Ÿæ˜¾ç¤ºæœåŠ¡å™¨
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "è™šæ‹Ÿæ˜¾ç¤ºå·²å¯åŠ¨"
          
      - name: ğŸš€ è¿è¡Œç»­æœŸè„šæœ¬
        env:
          EMAIL: ${{ secrets.LOGIN_EMAIL }}
          PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
          LOGIN_URL: ${{ secrets.LOGIN_URL || 'https://dashboard.katabump.com/auth/login' }}
          RENEW_URL: ${{ secrets.RENEW_URL || 'https://dashboard.katabump.com/servers/edit?id=124653' }}
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œç»­æœŸä»»åŠ¡..."
          echo "ğŸ”§ é…ç½®ä¿¡æ¯:"
          echo "ğŸ“§ é‚®ç®±: ${EMAIL:0:3}***"
          echo "ğŸ”— ç™»å½•URL: $LOGIN_URL"
          echo "ğŸ”— ç»­æœŸURL: $RENEW_URL"
          echo "========================"
          python main.py
          
      - name: ğŸ“Š æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€
        if: always()
        run: |
          echo "================================="
          echo "ğŸ“‹ ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo "ğŸ“ å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“‚ æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          echo "================================="
          
          # æ˜¾ç¤ºæ—¥å¿—æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "renew.log" ]; then
            echo "ğŸ“„ æ‰§è¡Œæ—¥å¿—:"
            cat renew.log
          fi
          
      - name: ğŸ“¸ ä¸Šä¼ æˆªå›¾å’Œæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: æ‰§è¡Œç»“æœ-${{ github.run_number }}
          path: |
            /tmp/*.png
            renew.log
            *.log
          retention-days: 7
          if-no-files-found: ignore
          
      - name: ğŸ“¬ å‘é€é€šçŸ¥ (å¯é€‰)
        if: always()
        run: |
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… ç»­æœŸä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼"
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æˆåŠŸé€šçŸ¥ï¼Œæ¯”å¦‚ï¼š
            # curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            #   -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            #   -d "text=âœ… æœåŠ¡å™¨ç»­æœŸæˆåŠŸ - $(date)"
          else
            echo "âŒ ç»­æœŸä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼"
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å¤±è´¥é€šçŸ¥
          fi
          
      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          # æ¸…ç†å¯èƒ½çš„ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/chrome* /tmp/.X* 2>/dev/null || true
          echo "ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
