# .github/workflows/auto_renew.yml
name: Auto Server Renew

on:
  # å®šæ—¶è¿è¡Œ - æ¯å¤©UTC 2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰
  schedule:
    - cron: '0 2 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡ŒåŸå› '
        required: false
        default: 'æ‰‹åŠ¨æµ‹è¯•'
        type: string

# ç¯å¢ƒå˜é‡
env:
  PYTHONUNBUFFERED: 1
  DISPLAY: :99

# è®¾ç½®æƒé™
permissions:
  contents: read

jobs:
  renew-server:
    name: ç»­æœŸæœåŠ¡å™¨
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          # æ›´æ–°åŒ…åˆ—è¡¨
          sudo apt-get update -qq
          
          # å®‰è£…Chromeå’Œç›¸å…³ä¾èµ–
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update -qq
          
          sudo apt-get install -y -qq \
            google-chrome-stable \
            xvfb \
            fonts-liberation \
            libasound2 \
            libatk-bridge2.0-0 \
            libdrm2 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libgbm1 \
            libxss1 \
            libnss3
            
      - name: ğŸ” æ£€æŸ¥Chromeç‰ˆæœ¬
        run: |
          CHROME_VERSION=$(google-chrome --version)
          echo "Chromeç‰ˆæœ¬: $CHROME_VERSION"
          
      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install \
            selenium==4.15.0 \
            undetected-chromedriver \
            playwright==1.40.0 \
            requests \
            loguru
            
      - name: ğŸ­ å®‰è£…Playwrightæµè§ˆå™¨
        run: |
          playwright install chromium
          
      - name: ğŸ–¥ï¸ å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤º
        run: |
          # å¯åŠ¨Xvfbè™šæ‹Ÿæ˜¾ç¤ºæœåŠ¡å™¨
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "è™šæ‹Ÿæ˜¾ç¤ºå·²å¯åŠ¨"
          
      - name: ğŸš€ è¿è¡Œç»­æœŸè„šæœ¬
        env:
          EMAIL: ${{ secrets.LOGIN_EMAIL }}
          PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
          LOGIN_URL: ${{ secrets.LOGIN_URL }}
          RENEW_URL: ${{ secrets.RENEW_URL }}
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œç»­æœŸä»»åŠ¡..."
          python main.py
          
      - name: ğŸ“Š æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€
        if: always()
        run: |
          echo "================================="
          echo "ğŸ“‹ ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo "ğŸ“ å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“‚ æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          echo "================================="
          
          # æ˜¾ç¤ºæ—¥å¿—æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "renew.log" ]; then
            echo "ğŸ“„ æ‰§è¡Œæ—¥å¿—:"
            cat renew.log
          fi
          
      - name: ğŸ“¸ ä¸Šä¼ æˆªå›¾å’Œæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: æ‰§è¡Œç»“æœ-${{ github.run_number }}
          path: |
            /tmp/*.png
            renew.log
            *.log
          retention-days: 7
          if-no-files-found: ignore
          
      - name: ğŸ“¬ å‘é€é€šçŸ¥ (å¯é€‰)
        if: always()
        run: |
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… ç»­æœŸä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼"
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æˆåŠŸé€šçŸ¥ï¼Œæ¯”å¦‚ï¼š
            # curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            #   -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            #   -d "text=âœ… æœåŠ¡å™¨ç»­æœŸæˆåŠŸ - $(date)"
          else
            echo "âŒ ç»­æœŸä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼"
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å¤±è´¥é€šçŸ¥
          fi
          
      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          # æ¸…ç†å¯èƒ½çš„ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/chrome* /tmp/.X* 2>/dev/null || true
          echo "ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
